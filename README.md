# Сервис распознавания лиц

# Содержание
1. [Описание структуры](#описание-структуры)
2. [Установка](#установка)
3. [Работа с сервисом](#работа-с-сервисом)
4. [API сервиса](#api-сервиса)
5. [Документация сервиса](#документация-сервиса)
6. [Авторы](#авторы)


![Same person. ServiceFR](/assets/same_pers.png "Пример идентификации целевого лица")

![Same person. ServiceFR](/assets/not_same_pers.png "Пример идентификации лица, которое не является целевым")

## Описание структуры

В файле `service.py` определён базовый класс взаимодействия сервисов.
Сервис распознавания лиц запускается из `run.py`, который используется класс `ServiceFR`, определённый в
`fr_service.py`. Здесь переопределены функции основной работы (`_do_job`) и обработки запросов (`_request_handler`). 
При этом в процессе распознавания используется модуль `Camera` из файла `cam.py`.

## Установка 
Для работы с текущим модулем необходимо установить зависимости из файла `requirements.txt`. Рекомендуется использовать 
виртуальную среду.

1. Создание виртуального окружения:
    ```
    python -m venv <path>
    ```

2. Активация окружения:
   * для Linux:
    ```
    source venv/bin/activate
    ```
   * для Windows (предварительно запустить PowerShell от имени администратора и выполнить
   ```set-executionpolicy remotesigned```):
    ```
    venv\Scripts\activate
    ```

3. Установка зависимостей:
    ```
    pip install -r requirements.txt
    ```
    
4. Установка пакетов системы:
    ```
    pip install -e .
    ```

## Работа с сервисом

Для начала работы с сервисом необходимо создать экземпляр класса `ServiceFR`, передав IP-адрес и порт, по которым он 
будет принимать запросы, и запустить его, вызвав функцию `start()` (пример в `run.py`):
```
service_var = ServiceFR("localhost", 8888)
service_var.start()
```

Для запуска сервиса необходимо вызвать из корневого каталога скрипт `run.py`

> python -m fr_service.run


Сервис умеет поддерживать некоторое количество запросов, которые подробно рассмотрены в следующем разделе. Для отправки
запроса используется функция `run_client()`, которая работает в параллельном потоке. Чтобы отправить запрос на текущий 
сервис, необходимо указать информацию об IP-адресе и порте, а также текст отправляемой команды. В примере ниже на 
текущий сервис отправляется запрос на приостановку (пауза) основной работы:
```
service_dummy.run_client("localhost", 8888, "disable")
```
Пример отправки обработки запросов `ServiceFR` представлен в блоке `dummy_client`. 

## API сервиса

Помимо зарезервированных команд (`disable`, `enable`, `close`, `restart`) сервис поддерживает следующие специфичные 
команды:

* `getFrame` - возвращает RGB кадр в base64 формате.

* `getDepth` - возвращает Grayscale кадр в base64 формате.

* `getFace` - возвращает часть кадра с лицом, если оно есть, или кадр целиком, если лица нет, в base64 формате.

* `getRect` - возвращает координаты прямоугольника, соответствующему лицу на кадре, в формате [x, y, width, height] (координаты будут нулями, если лица на кадре не обнаружено).

* `applyThreshold_<value>` - применяет новое значение порога `<value>`, если оно в пределах (0., 1.] (по умолчанию порог 0.67). Возвращает "ok", если был установлен порог, иначе "failed".

* `startTracking` - сервис начинает отслеживание персоны. Если удалось определить лицо возвращает "ok", иначе "failed".

* `target` - аналогично getRect. Возвращает "empty", если персона для отслеживания не определена.

* `stopTracking` - прекращает отслеживание персоны. Всегда возвращает "ok".

* `applyGrayscale` - переводит обработку кадра в градации серого. Возвращает "ok".

* `applyRgb` - переводит обработку кадра в RGB (используется по умолчанию). Возвращает "ok".

* `getThreshold` - возвращает текущее значение порога определения лица.

* `getColorMap` - возвращает текущий режим цветового пространства для обработки: "rgb" или "gray".

## Документация сервиса

Подробности об устройстве классов и методов доступны в автоматически сгенерированной документации:
```
./docs/build/html/index.html
```

## Авторы

  - *Клейменов Артём*
  - *Толстенко Лада*
